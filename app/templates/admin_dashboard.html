{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header mb-5">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-chart-line text-primary"></i>
                    Dashboard
                </h1>
            </div>
            <div class="col-md-4 text-right">
                <button class="btn btn-primary" id="refresh-analytics">
                    <i class="fas fa-sync-alt"></i>
                    Refresh Data
                </button>
            </div>
        </div>
    </div>

    <!-- Key Metrics Overview -->
    <div id="analytics-dashboard"></div>
    <!-- Detailed Analytics Sections -->
    <div class="analytics-sections" style="margin-top: 0;">
        <div class="row">
            <!-- Sentiment Analysis Chart -->
            <div class="col-md-6">
                <div class="card mb-0" style="margin-bottom: 0 !important;">
                    <div class="card-header" style="padding: 0.5rem 1rem;">
                        <h3 class="card-title" style="margin: 0; font-size: 1rem;">
                            <i class="fas fa-brain text-primary"></i>
                            AI Sentiment Analysis
                        </h3>
                    </div>
                    <div class="card-body" style="padding: 0.5rem;">
                        <div style="position: relative; height: 200px;">
                            <canvas id="sentiment-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart placeholder -->
            <div class="col-md-6">
                <div class="card mb-0" style="margin-bottom: 0 !important;">
                    <div class="card-body" style="padding: 0.5rem;">
                        <div style="position: relative; height: 200px;">
                            <canvas id="trends-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Alerts container (hidden) -->
        <div id="alerts-container" style="display:none;"></div>
        <!-- Top Rated Experiences Row -->
        <div class="row" style="margin-top: -20px;">
            <div class="col-md-6">
                <div class="card mb-0" style="margin-bottom: 0 !important;">
                    <div class="card-header" style="padding: 0.5rem 1rem;">
                        <h3 class="card-title" style="margin: 0; font-size: 1rem;">
                            <i class="fas fa-star text-warning"></i>
                            Top Rated Experiences
                        </h3>
                    </div>
                    <div class="card-body" style="padding: 0.5rem;">
                        <div class="experience-list" style="padding: 0; margin: 0;">                            <div class="experience-item" style="padding: 0.25rem 0; display: flex; justify-content: space-between; align-items: center; margin: 0;">
                                <div class="experience-info">
                                    <h5 style="margin: 0; font-size: 0.9rem;">Skyline Rooftop Restaurant</h5>
                                    <p class="text-muted" style="margin: 0; font-size: 0.8rem;">Fine dining with city views</p>
                                </div>
                                <div class="experience-rating" style="display: flex; align-items: center;">
                                    <span class="rating-value" style="margin-right: 0.5rem; font-size: 0.9rem; font-weight: bold;">4.8</span>
                                    <div class="rating-stars" style="font-size: 0.8rem;">⭐⭐⭐⭐⭐</div>
                                </div>
                            </div>
                            
                            <div class="experience-item">
                                <div class="experience-info">
                                    <h5 style="margin: 0; font-size: 0.9rem;">Luxury Spa & Wellness</h5>
                                    <p class="text-muted" style="margin: 0; font-size: 0.8rem;">Full-service spa treatments</p>
                                </div>
                                <div class="experience-rating" style="display: flex; align-items: center;">
                                    <span class="rating-value" style="margin-right: 0.5rem; font-size: 0.9rem; font-weight: bold;">4.7</span>
                                    <div class="rating-stars" style="font-size: 0.8rem;">⭐⭐⭐⭐⭐</div>
                                </div>
                            </div>
                            
                            <div class="experience-item" style="padding: 0.25rem 0; display: flex; justify-content: space-between; align-items: center; margin: 0;">
                                <div class="experience-info">
                                    <h5 style="margin: 0; font-size: 0.9rem;">Adventure Sports Package</h5>
                                    <p class="text-muted" style="margin: 0; font-size: 0.8rem;">Outdoor activities and adventures</p>
                                </div>
                                <div class="experience-rating" style="display: flex; align-items: center;">
                                    <span class="rating-value" style="margin-right: 0.5rem; font-size: 0.9rem; font-weight: bold;">4.6</span>
                                    <div class="rating-stars" style="font-size: 0.8rem;">⭐⭐⭐⭐⭐</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loyalty Distribution -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-users text-secondary"></i>
                            Guest Loyalty Distribution
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="loyalty-stats">
                            <div class="loyalty-tier">
                                <div class="tier-info">
                                    <span class="tier-name">Platinum</span>
                                    <span class="tier-count">24 guests</span>
                                </div>
                                <div class="tier-progress">
                                    <div class="progress">
                                        <div class="progress-bar" style="width: 20%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="loyalty-tier">
                                <div class="tier-info">
                                    <span class="tier-name">Gold</span>
                                    <span class="tier-count">48 guests</span>
                                </div>
                                <div class="tier-progress">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-warning" style="width: 40%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="loyalty-tier">
                                <div class="tier-info">
                                    <span class="tier-name">Silver</span>
                                    <span class="tier-count">32 guests</span>
                                </div>
                                <div class="tier-progress">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-success" style="width: 27%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="loyalty-tier">
                                <div class="tier-info">
                                    <span class="tier-name">Standard</span>
                                    <span class="tier-count">16 guests</span>
                                </div>
                                <div class="tier-progress">
                                    <div class="progress">
                                        <div class="progress-bar bg-secondary" style="width: 13%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights Panel -->
    <div class="ai-insights-section mb-5">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-robot text-primary"></i>
                    AI-Generated Insights
                </h2>
                <p class="card-subtitle">Intelligent recommendations based on data analysis</p>
            </div>
            <div class="card-body">
                <div class="insights-grid grid grid-2">
                    <div class="insight-card">
                        <div class="insight-icon">
                            <i class="fas fa-trending-up text-success"></i>
                        </div>
                        <div class="insight-content">
                            <h4>Positive Trend Detected</h4>
                            <p>Guest satisfaction has improved by 15% this week, primarily due to enhanced dining experiences.</p>
                            <span class="insight-confidence">AI Confidence: 92%</span>
                        </div>
                    </div>
                    
                    <div class="insight-card">
                        <div class="insight-icon">
                            <i class="fas fa-exclamation-circle text-warning"></i>
                        </div>
                        <div class="insight-content">
                            <h4>Service Area Alert</h4>
                            <p>Room service response times showing negative sentiment patterns. Recommend staff training.</p>
                            <span class="insight-confidence">AI Confidence: 87%</span>
                        </div>
                    </div>
                    
                    <div class="insight-card">
                        <div class="insight-icon">
                            <i class="fas fa-lightbulb text-primary"></i>
                        </div>
                        <div class="insight-content">
                            <h4>Recommendation Optimization</h4>
                            <p>Mediterranean cuisine recommendations show 40% higher satisfaction rates among Gold-tier guests.</p>
                            <span class="insight-confidence">AI Confidence: 95%</span>
                        </div>
                    </div>
                    
                    <div class="insight-card">
                        <div class="insight-icon">
                            <i class="fas fa-clock text-info"></i>
                        </div>
                        <div class="insight-content">
                            <h4>Peak Activity Forecast</h4>
                            <p>Spa bookings expected to increase by 25% this weekend. Consider additional staff scheduling.</p>
                            <span class="insight-confidence">AI Confidence: 89%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Actions -->
    <div class="management-actions">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-cogs text-secondary"></i>
                    Quick Management Actions
                </h2>
            </div>
            <div class="card-body">
                <div class="actions-grid grid grid-2">
                    <a href="/admin/add-guest" class="btn btn-primary btn-lg">
                        <i class="fas fa-user-plus"></i>
                        Add New Guest
                    </a>
                    <button class="btn btn-secondary btn-lg">
                        <i class="fas fa-download"></i>
                        Export Reports
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Admin Dashboard Specific Styles */
.dashboard-header {
    background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
    padding: var(--spacing-xl);
    border-radius: var(--radius-lg);
    border: 1px solid var(--gray-200);
}

.experience-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid var(--gray-200);
}

.experience-item:last-child {
    border-bottom: none;
}

.experience-rating {
    text-align: right;
}

.rating-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary-color);
}

.rating-stars {
    font-size: 0.875rem;
}

.loyalty-tier {
    margin-bottom: var(--spacing-lg);
}

.tier-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--spacing-sm);
}

.tier-name {
    font-weight: 600;
}

.tier-count {
    color: var(--gray-600);
}

.insights-grid {
    gap: var(--spacing-lg);
}

.insight-card {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    background: var(--gray-50);
}

.insight-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.insight-content h4 {
    margin-bottom: var(--spacing-sm);
    font-size: 1rem;
}

.insight-content p {
    margin-bottom: var(--spacing-sm);
    font-size: 0.875rem;
    color: var(--gray-600);
}

.insight-confidence {
    font-size: 0.75rem;
    color: var(--primary-color);
    font-weight: 500;
}

.actions-grid {
    gap: var(--spacing-md);
}

.actions-grid .btn {
    padding: var(--spacing-lg);
    flex-direction: column;
    gap: var(--spacing-sm);
}

.alert-item {
    display: flex;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-md);
    background: white;
}

.alert-severity {
    flex-shrink: 0;
}

.alert-content {
    flex: 1;
}

.alert-text {
    font-size: 0.875rem;
    margin-bottom: var(--spacing-xs);
}

.alert-meta {
    font-size: 0.75rem;
}

.sentiment-item {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--gray-200);
}

.sentiment-item:last-child {
    border-bottom: none;
}

@media (max-width: 768px) {
    .dashboard-header .row {
        text-align: center;
    }
    
    .dashboard-header .col-md-4 {
        margin-top: var(--spacing-md);
    }
    
    .experience-item {
        flex-direction: column;
        text-align: center;
        gap: var(--spacing-sm);
    }
    
    .insight-card {
        flex-direction: column;
        text-align: center;
    }
    
    .actions-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-load analytics dashboard
    window.guestApp.refreshAnalytics();
    
    // Load alerts
    loadActiveAlerts();
    
    // Initialize charts with sample data
    initializeAdminCharts();
});

async function loadActiveAlerts() {
    const container = document.getElementById('alerts-container');
    if (!container) return; // Skip if container doesn't exist
    try {
        const response = await fetch('/api/analytics/alerts', {
            credentials: 'include'
        });
        const result = await response.json();
        
        if (result.success && result.data.alerts.length > 0) {
            const alertsHtml = result.data.alerts.slice(0, 5).map(alert => {
                // Handle both feedback API alerts and analytics alerts
                const priority = alert.priority || (alert.severity === 'high' ? 'high' : 'medium');
                const title = alert.title || `Feedback Alert`;
                const message = alert.message || alert.feedback_text?.substring(0, 150) + '...';
                const rating = alert.rating || 'N/A';
                const guestName = alert.guest_name || alert.guest_id || 'Unknown';
                const sentiment = alert.sentiment || 'unknown';
                const category = alert.category || 'general';
                const createdAt = alert.created_at || alert.timestamp;
                
                const priorityClass = priority === 'high' ? 'danger' : priority === 'medium' ? 'warning' : 'info';
                const priorityIcon = priority === 'high' ? '🔴' : priority === 'medium' ? '🟡' : '🟢';
                const sentimentIcon = sentiment === 'positive' ? '😊' : sentiment === 'negative' ? '😔' : '😐';
                
                return `
                    <div class="alert-item p-3 mb-3 border-left border-${priorityClass} bg-light">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="alert-content flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge badge-${priorityClass} mr-2">
                                        ${priorityIcon} ${priority.toUpperCase()}
                                    </span>
                                    <span class="badge badge-secondary mr-2">${category}</span>
                                    <span class="text-muted">${sentimentIcon} ${sentiment}</span>
                                </div>
                                <h6 class="font-weight-bold mb-1">${title}</h6>
                                <p class="mb-2 text-muted">${message}</p>
                                <div class="alert-meta small text-muted">
                                    👤 Guest: ${guestName} | 
                                    ⭐ Rating: ${rating}/5 | 
                                    📅 ${new Date(createdAt).toLocaleDateString()} ${new Date(createdAt).toLocaleTimeString()}
                                </div>
                            </div>
                            <div class="alert-actions">
                                ${alert.status === 'unread' ? '<span class="badge badge-primary">NEW</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const headerHtml = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-bell text-warning mr-2"></i>
                        Recent Alerts (${result.data.alerts.length})
                    </h5>
                    <div class="text-muted">
                        <span class="badge badge-primary">${result.data.unread_count}</span> unread
                    </div>
                </div>
            `;
            
            container.innerHTML = headerHtml + alertsHtml;
        } else {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                    <h5 class="text-success">No Active Alerts</h5>
                    <p class="text-muted">All guest feedback is being handled properly! 🎉</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading alerts:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Failed to load alerts. Please try again.
            </div>
        `;
    }
}

function initializeAdminCharts() {
    // Sentiment Analysis Chart
    const sentimentCtx = document.getElementById('sentiment-chart');
    if (sentimentCtx) {
        new Chart(sentimentCtx, {
            type: 'doughnut',
            data: {
                labels: ['Positive', 'Neutral', 'Negative'],
                datasets: [{
                    data: [75, 20, 5],
                    backgroundColor: [
                        '#10b981',
                        '#6b7280', 
                        '#dc2626'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Trends Chart
    const trendsCtx = document.getElementById('trends-chart');
    if (trendsCtx) {
        new Chart(trendsCtx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Satisfaction Rate (%)',
                    data: [85, 87, 84, 88, 91, 89, 92],
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 80,
                        max: 100
                    }
                }
            }
        });
    }
}
</script>
{% endblock %}
